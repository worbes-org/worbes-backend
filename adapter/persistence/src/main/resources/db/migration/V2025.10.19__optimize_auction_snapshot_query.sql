-- ============================================================================
-- 경매 스냅샷 쿼리 최적화
-- 작성일: 2025-10-19
-- 목적: 6초 → 2ms 성능 개선
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 기존 인덱스 정리
-- ----------------------------------------------------------------------------
DROP INDEX IF EXISTS idx_snapshot_latest;

-- ----------------------------------------------------------------------------
-- 새 최적화 인덱스 추가
-- ----------------------------------------------------------------------------
CREATE INDEX IF NOT EXISTS idx_auction_snapshot_time_realm
    ON auction_snapshot (time DESC, realm_id);

-- ----------------------------------------------------------------------------
-- 통계 업데이트
-- ----------------------------------------------------------------------------
ANALYZE auction_snapshot;

-- ----------------------------------------------------------------------------
-- 4. 완료 로그
-- ----------------------------------------------------------------------------
DO
$$
    BEGIN
        RAISE NOTICE '✅ Migration V2025.10.19.001 completed!';
        RAISE NOTICE '- Created: idx_auction_snapshot_time_realm';
        RAISE NOTICE '- Expected performance: 6s → 2ms';
        RAISE NOTICE '⚠️  Production: Run CONCURRENTLY version manually!';
    END
$$;
