<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.worbes.adapter.persistence.mybatis.item.ItemMybatisMapper">

    <select id="findBy" resultType="com.worbes.adapter.persistence.mybatis.item.ItemMybatisDto">
        SELECT
        id,
        name,
        level,
        class_id,
        subclass_id,
        inventory_type,
        quality,
        icon,
        crafting_tier,
        is_stackable,
        expansion_id,
        display_id
        FROM item
        WHERE 1 = 1
        <if test="query.classId != null">
            AND class_id = #{query.classId}
            <if test="query.subclassId != null">
                <!-- NOTE: subclassId는 classId가 있어야만 필터링됩니다. 도메인 설계상 subclass는 class에 종속됩니다. -->
                AND subclass_id = #{query.subclassId}
            </if>
        </if>
        <if test="query.name != null and query.name != ''">
            AND EXISTS (
            SELECT 1
            FROM jsonb_each_text(name)
            WHERE value ILIKE CONCAT('%', #{query.name}, '%')
            )
        </if>
        <if test="query.minQuality != null">
            AND quality &gt;= #{query.minQuality}
        </if>
        <if test="query.maxQuality != null">
            AND quality &lt;= #{query.maxQuality}
        </if>
        <if test="query.expansionId != null">
            AND expansion_id = #{query.expansionId}
        </if>
    </select>

</mapper>
